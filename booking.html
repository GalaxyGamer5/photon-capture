<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking | Photon Capture</title>
    <meta name="description"
        content="Book your photo session with Photon Capture. Portrait, Event, and Pet photography services.">
    <meta name="robots" content="noindex, nofollow"> <!-- Don't index booking page usually -->

    <!-- Open Graph -->
    <meta property="og:title" content="Book Your Session | Photon Capture">
    <meta property="og:description" content="Secure your date for authentic photography.">
    <meta property="og:image"
        content="https://lh3.googleusercontent.com/pw/AP1GczMg8dCbICmYoQg0AlDyi94yWWzve2ADbZ1CBpChw50UvbdRXWfdterwjKMf1R-eohQZibtIiQzB-2_D-Xk10eX_uPqdoboNFgQgZFR-ANhxRBzsAkRecjDscUecVvdEG7Loo4afmrOIRceiLcgmjCgl=w1122-h1684-s-no-gm?authuser=1">

    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- Navigation -->
    <header>
        <div class="container">
            <a href="index.html" class="logo">Photon<span>-Capture</span></a>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html#hero" data-i18n="nav.home">Startseite</a></li>
                    <li><a href="index.html#about" data-i18n="nav.about">√úber mich</a></li>
                    <li><a href="index.html#services" data-i18n="nav.services">Leistungen</a></li>
                    <li><a href="index.html#gallery" data-i18n="nav.gallery">Galerie</a></li>
                    <li><a href="index.html#pricing" data-i18n="nav.pricing">Preise</a></li>
                    <li><a href="index.html#contact" data-i18n="nav.contact">Kontakt</a></li>
                </ul>
                <button class="lang-toggle" aria-label="Switch Language">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                </button>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Booking Section -->
    <section class="contact-section" style="padding-top: 120px; min-height: 80vh;">
        <div class="container">
            <div class="booking-wrapper" style="max-width: 700px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 3rem;">
                    <h3 data-i18n="booking.title" style="font-size: 2rem; margin-bottom: 1rem;">Buchung abschlie√üen</h3>
                    <p data-i18n="booking.subtitle" style="color: var(--text-secondary);">
                        F√ºlle das Formular aus, um deine Session zu reservieren. Ich melde mich so schnell wie m√∂glich
                        bei dir.
                    </p>
                </div>

                <!-- Calendar Pre-fill Confirmation (hidden by default) -->
                <div id="calendar-confirmation"
                    style="display: none; background: rgba(255, 51, 102, 0.1); border: 1px solid var(--accent-color); border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: center;">
                    <span style="color: var(--accent-color); font-weight: 500;">‚úì Termin aus Kalender √ºbernommen</span>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.5rem 0 0 0;"
                        id="calendar-datetime-display"></p>
                </div>

                <form id="booking-form"
                    style="background-color: var(--surface-color); padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.05);">

                    <!-- Step 1: Date & Service -->
                    <div class="booking-step" style="margin-bottom: 3rem;">
                        <div class="info-item" style="margin-bottom: 1.5rem;">
                            <div class="info-icon">üìÖ</div>
                            <div class="info-content">
                                <h4 data-i18n="booking.step1">1. Termin w√§hlen</h4>
                                <p data-i18n="booking.step1.desc">W√§hle dein Wunschdatum und die Uhrzeit.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="service" data-i18n="contact.form.service">Worum geht es?</label>
                            <select id="service" class="form-control">
                                <option value="portrait" data-i18n="contact.form.service.portrait">Portr√§t-Session
                                </option>
                                <option value="event" data-i18n="contact.form.service.event">Event-Begleitung</option>
                                <option value="pet" data-i18n="contact.form.service.pet">Tierfotografie</option>
                                <option value="other" data-i18n="contact.form.service.other">Sonstiges / Allgemeine
                                    Frage</option>
                            </select>
                        </div>

                        <div id="date-time-section" class="form-group" style="display: flex; gap: 1rem;">
                            <div style="flex: 1;">
                                <label for="date" data-i18n="booking.date">Datum</label>
                                <input type="date" id="date" class="form-control" required>
                            </div>
                            <div style="flex: 1;">
                                <label for="time" data-i18n="booking.time">Uhrzeit</label>
                                <input type="time" id="time" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Extras -->
                    <div id="extras-step" class="booking-step" style="margin-bottom: 3rem;">
                        <div class="info-item" style="margin-bottom: 1.5rem;">
                            <div class="info-icon">‚ú®</div>
                            <div class="info-content">
                                <h4 data-i18n="booking.step2">2. Extras hinzuf√ºgen</h4>
                                <p data-i18n="booking.step2.desc">Passe dein Paket mit zus√§tzlichen Optionen an.</p>
                            </div>
                        </div>

                        <div id="extras-container">
                            <!-- Extras will be injected here via JavaScript -->
                        </div>
                        <div id="booking-tips" style="margin-top: 1.5rem;"></div>

                        <!-- Price Summary -->
                        <div id="price-summary"
                            style="margin-top: 2rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); display: none;">
                            <h4 style="margin-bottom: 1rem; font-size: 1.1rem;" data-i18n="booking.price_summary.title">
                                Preis√ºbersicht</h4>
                            <div id="price-breakdown"
                                style="margin-bottom: 1rem; font-size: 0.95rem; color: var(--text-secondary);"></div>
                            <div id="price-discount"
                                style="margin-bottom: 0.5rem; font-size: 0.95rem; color: var(--accent-color); display: none;">
                            </div>
                            <div id="price-total"
                                style="font-size: 1.3rem; font-weight: 600; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Contact Info -->
                    <div class="booking-step" style="margin-bottom: 2rem;">
                        <div class="info-item" style="margin-bottom: 1.5rem;">
                            <div class="info-icon">üì©</div>
                            <div class="info-content">
                                <h4 data-i18n="booking.step3">3. Anfrage senden</h4>
                                <p data-i18n="booking.step3.desc">Ich best√§tige den Termin pers√∂nlich.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name" data-i18n="contact.form.name">Dein Name</label>
                            <input type="text" id="name" class="form-control" placeholder="Wie hei√üt du?"
                                data-i18n="contact.form.name.placeholder" required>
                        </div>
                        <div class="form-group">
                            <label for="email" data-i18n="contact.form.email">Deine E-Mail</label>
                            <input type="email" id="email" class="form-control"
                                placeholder="Wie kann ich dich erreichen?" data-i18n="contact.form.email.placeholder"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="message" data-i18n="contact.form.message">Deine Nachricht</label>
                            <textarea id="message" class="form-control"
                                placeholder="Erz√§hl mir ein bisschen von deinen Pl√§nen..."
                                data-i18n="contact.form.message.placeholder"></textarea>
                        </div>
                    </div>

                    <input type="hidden" id="total_price_input" name="total_price">
                    <input type="hidden" id="price_details_input" name="price_details">
                    <input type="hidden" id="base_price_input" name="base_price">
                    <input type="hidden" id="extras_breakdown_input" name="extras_breakdown">
                    <input type="hidden" id="discount_breakdown_input" name="discount_breakdown">
                    <button type="submit" class="cta-button" style="border: none; cursor: pointer; width: 100%;"
                        data-i18n="booking.btn">Buchung anfragen</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="social-links">
                <a href="https://www.instagram.com/photon.capture.fotografie/" target="_blank"
                    rel="noopener noreferrer">Instagram</a>
            </div>
            <div class="footer-links" style="margin-bottom: 1rem;">
                <a href="agb.html" style="font-size: 0.9rem; color: var(--text-secondary); margin-right: 1rem;"
                    data-i18n="footer.agb">AGB</a>
                <a href="impressum.html" style="font-size: 0.9rem; color: var(--text-secondary);"
                    data-i18n="footer.impressum">Impressum</a>
            </div>
            <p class="copyright" data-i18n="footer.copyright">&copy; 2024 Photon-Capture. Alle Rechte vorbehalten.</p>
        </div>
    </footer>

    <script src="js/translations.js"></script>
    <script src="js/main.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="js/email-handler.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const serviceSelect = document.getElementById('service');
            const extrasContainer = document.getElementById('extras-container');
            const bookingTips = document.getElementById('booking-tips');
            const urlParams = new URLSearchParams(window.location.search);
            const packageParam = urlParams.get('package');
            const dateParam = urlParams.get('date');
            const timeParam = urlParams.get('time');

            // Pre-select package
            if (packageParam && serviceSelect) {
                serviceSelect.value = packageParam;
            }

            // Pre-fill date from calendar
            const dateInput = document.getElementById('date');
            if (dateParam && dateInput) {
                dateInput.value = dateParam;
                // Make field readonly and add visual indicator
                dateInput.style.borderColor = 'var(--accent-color)';
                dateInput.style.background = 'rgba(255, 51, 102, 0.05)';
            }

            // Pre-fill time from calendar
            const timeInput = document.getElementById('time');
            if (timeParam && timeInput) {
                timeInput.value = timeParam;
                // Make field readonly and add visual indicator
                timeInput.style.borderColor = 'var(--accent-color)';
                timeInput.style.background = 'rgba(255, 51, 102, 0.05)';
            }

            // Define extras configuration
            const extrasConfig = {
                portrait: ['photos', 'location', 'time_standard'],
                pet: ['photos', 'location', 'time_standard'],
                event: ['duration_event', 'express'],
                other: []
            };

            // Function to generate HTML for extras
            function renderExtras(service) {
                extrasContainer.innerHTML = ''; // Clear current extras
                const config = extrasConfig[service] || extrasConfig['portrait']; // Default to portrait if unknown

                // Get references to sections that should be hidden for "other" service
                const dateTimeSection = document.getElementById('date-time-section');
                const extrasStep = document.getElementById('extras-step');
                const dateInput = document.getElementById('date');
                const timeInput = document.getElementById('time');

                // Hide date/time and extras sections for general questions
                if (service === 'other') {
                    if (dateTimeSection) dateTimeSection.style.display = 'none';
                    if (extrasStep) extrasStep.style.display = 'none';
                    // Remove required attribute when hidden
                    if (dateInput) dateInput.removeAttribute('required');
                    if (timeInput) timeInput.removeAttribute('required');
                } else {
                    if (dateTimeSection) dateTimeSection.style.display = 'flex';
                    if (extrasStep) extrasStep.style.display = 'block';
                    // Add back required attribute when shown
                    if (dateInput) dateInput.setAttribute('required', 'required');
                    if (timeInput) timeInput.setAttribute('required', 'required');
                }

                if (config.length === 0) {
                    extrasContainer.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;" data-i18n="contact.form.extras.none">Keine speziellen Extras f√ºr diese Auswahl.</p>';

                    // Re-apply translations and update pricing even when no extras
                    if (window.updateContent) {
                        window.updateContent();
                    }
                    updateTips();
                    updatePricing();
                    return;
                }

                config.forEach(type => {
                    let html = '';
                    if (type === 'photos') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.photos.label">Mehr bearbeitete Bilder</label>
                                <select name="extra_photos" class="form-control">
                                    <option value="none" data-i18n="contact.form.extras.photos.opt0">Keine zus√§tzlichen Bilder</option>
                                    <option value="plus10" data-i18n="contact.form.extras.photos.opt1">+10 Bilder</option>
                                    <option value="plus25" data-i18n="contact.form.extras.photos.opt2">+25 Bilder</option>
                                    <option value="plus50" data-i18n="contact.form.extras.photos.opt3">+50 Bilder</option>
                                </select>
                            </div>`;
                    } else if (type === 'location') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.location.label">Zus√§tzliche Location</label>
                                <select name="extra_location" class="form-control">
                                    <option value="none" data-i18n="contact.form.extras.location.opt0">Keine zus√§tzliche Location</option>
                                    <option value="plus1" data-i18n="contact.form.extras.location.opt1">+1 Location</option>
                                    <option value="plus2" data-i18n="contact.form.extras.location.opt2">+2 Locations</option>
                                </select>
                            </div>`;
                    } else if (type === 'time_standard') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.time.label">Verl√§ngerung der Shooting-Zeit</label>
                                <select name="extra_time" class="form-control">
                                    <option value="none" data-i18n="contact.form.extras.time.opt0">Keine Verl√§ngerung</option>
                                    <option value="plus30m" data-i18n="contact.form.extras.time.opt1">+30 Minuten</option>
                                    <option value="plus1h" data-i18n="contact.form.extras.time.opt2">+1 Stunde</option>
                                    <option value="plus2h" data-i18n="contact.form.extras.time.opt3">+2 Stunden</option>
                                </select>
                            </div>`;
                    } else if (type === 'album') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.album.label">Hochzeitsalbum</label>
                                <select name="extra_album" class="form-control">
                                    <option value="none" data-i18n="contact.form.extras.album.opt0">Kein Album</option>
                                    <option value="standard" data-i18n="contact.form.extras.album.opt1">Standard (20 Seiten)</option>
                                    <option value="premium" data-i18n="contact.form.extras.album.opt2">Premium (40 Seiten, Leder)</option>
                                </select>
                            </div>`;
                    } else if (type === 'video') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.video.label">Videograf</label>
                                <select name="extra_video" class="form-control">
                                    <option value="no" data-i18n="contact.form.extras.video.opt0">Nein</option>
                                    <option value="yes" data-i18n="contact.form.extras.video.opt1">Ja, Highlight-Video</option>
                                </select>
                            </div>`;
                    } else if (type === 'duration_event') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.duration.label">Buchungsdauer</label>
                                <select name="event_duration" class="form-control">
                                    <option value="2h" data-i18n="contact.form.extras.duration.opt2">2 Stunden (Minimum)</option>
                                    <option value="3h" data-i18n="contact.form.extras.duration.opt3">3 Stunden</option>
                                    <option value="4h" data-i18n="contact.form.extras.duration.opt4">4 Stunden</option>
                                    <option value="5h" data-i18n="contact.form.extras.duration.opt5">5 Stunden</option>
                                    <option value="6h" data-i18n="contact.form.extras.duration.opt6">6 Stunden</option>
                                    <option value="8h" data-i18n="contact.form.extras.duration.opt8">8 Stunden</option>
                                    <option value="open" data-i18n="contact.form.extras.duration.open">Open End</option>
                                </select>
                                <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-style: italic;" data-i18n="contact.form.extras.duration.open_note">Hinweis: Open End basiert auf 8 Stunden. Jede weitere Stunde wird mit 50‚Ç¨ berechnet.</small>
                            </div>`;
                    } else if (type === 'express') {
                        html = `
                            <div class="form-group">
                                <label data-i18n="contact.form.extras.express.label">Express-Bearbeitung</label>
                                <select name="extra_express" class="form-control">
                                    <option value="standard" data-i18n="contact.form.extras.express.opt0">Standard (1-2 Wochen)</option>
                                    <option value="express" data-i18n="contact.form.extras.express.opt1">Express (48 Stunden)</option>
                                    <option value="overnight" data-i18n="contact.form.extras.express.opt2">Overnight (24 Stunden)</option>
                                </select>
                            </div>`;
                    }
                    extrasContainer.innerHTML += html;
                });

                // Re-apply translations to new elements
                if (window.updateContent) {
                    window.updateContent();
                }

                // Setup tips listener
                const photosSelect = extrasContainer.querySelector('select[name="extra_photos"]');
                const locationSelect = extrasContainer.querySelector('select[name="extra_location"]');
                const timeSelect = extrasContainer.querySelector('select[name="extra_time"]');
                const expressSelect = extrasContainer.querySelector('select[name="extra_express"]');
                const durationSelect = extrasContainer.querySelector('select[name="event_duration"]');

                const inputs = [photosSelect, locationSelect, timeSelect, expressSelect, durationSelect];
                inputs.forEach(input => {
                    if (input) {
                        input.addEventListener('change', updateTips);
                        input.addEventListener('change', updatePricing);
                    }
                });

                updateTips();
                updatePricing();
            }

            // Pricing data structure
            const pricing = {
                photos: {
                    plus10: 10,
                    plus25: 20,
                    plus50: 35
                },
                location: {
                    plus1: 30,
                    plus2: 55
                },
                time: {
                    plus30m: 25,
                    plus1h: 50,
                    plus2h: 90
                },
                express: {
                    express: 60,
                    overnight: 120
                }
            };

            // Function to calculate pricing
            function updatePricing() {
                const photosSelect = extrasContainer.querySelector('select[name="extra_photos"]');
                const locationSelect = extrasContainer.querySelector('select[name="extra_location"]');
                const timeSelect = extrasContainer.querySelector('select[name="extra_time"]');
                const expressSelect = extrasContainer.querySelector('select[name="extra_express"]');
                const durationSelect = extrasContainer.querySelector('select[name="event_duration"]');

                const priceSummary = document.getElementById('price-summary');
                const priceBreakdown = document.getElementById('price-breakdown');
                const priceDiscount = document.getElementById('price-discount');
                const priceTotal = document.getElementById('price-total');

                const selectedService = serviceSelect.value;

                // Base package prices
                const basePrices = {
                    portrait: 125,
                    pet: 125,
                    event: 100, // per hour
                    other: 0  // Free for general questions
                };

                let basePrice = basePrices[selectedService] || 0;
                let durationHours = 0;
                let durationDiscount = 0;
                let durationDiscountPercent = 0;

                // Calculate event pricing based on duration
                if (selectedService === 'event' && durationSelect) {
                    const durationValue = durationSelect.value;

                    // Parse hours from duration value
                    if (durationValue.endsWith('h')) {
                        durationHours = parseInt(durationValue);
                    } else if (durationValue === 'open') {
                        durationHours = 8; // Estimate for open end
                    }

                    // Calculate base event price
                    basePrice = 100 * durationHours;

                    // Apply duration-based discounts
                    if (durationHours >= 8) {
                        durationDiscountPercent = 25;
                        durationDiscount = Math.round(basePrice * 0.25);
                    } else if (durationHours >= 6) {
                        durationDiscountPercent = 20;
                        durationDiscount = Math.round(basePrice * 0.20);
                    } else if (durationHours >= 4) {
                        durationDiscountPercent = 15;
                        durationDiscount = Math.round(basePrice * 0.15);
                    }

                    basePrice -= durationDiscount;
                }

                let extrasTotal = 0;
                let breakdown = [];
                let selectedCount = 0;

                // Calculate individual prices
                if (photosSelect && photosSelect.value !== 'none') {
                    const price = pricing.photos[photosSelect.value] || 0;
                    if (price > 0) {
                        breakdown.push({ name: photosSelect.options[photosSelect.selectedIndex].text, price });
                        extrasTotal += price;
                        selectedCount++;
                    }
                }

                if (locationSelect && locationSelect.value !== 'none') {
                    const price = pricing.location[locationSelect.value] || 0;
                    if (price > 0) {
                        breakdown.push({ name: locationSelect.options[locationSelect.selectedIndex].text, price });
                        extrasTotal += price;
                        selectedCount++;
                    }
                }

                if (timeSelect && timeSelect.value !== 'none') {
                    const price = pricing.time[timeSelect.value] || 0;
                    if (price > 0) {
                        breakdown.push({ name: timeSelect.options[timeSelect.selectedIndex].text, price });
                        extrasTotal += price;
                        selectedCount++;
                    }
                }

                if (expressSelect && expressSelect.value !== 'standard') {
                    const price = pricing.express[expressSelect.value] || 0;
                    if (price > 0) {
                        breakdown.push({ name: expressSelect.options[expressSelect.selectedIndex].text, price });
                        extrasTotal += price;
                        selectedCount++;
                    }
                }

                // Always show summary if base price exists
                if (basePrice === 0 && breakdown.length === 0) {
                    priceSummary.style.display = 'none';
                    return;
                }

                priceSummary.style.display = 'block';

                // Build breakdown HTML with base price
                let breakdownHTML = '';

                // Add base package
                if (basePrice > 0) {
                    const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
                    let priceDisplay = '';

                    if (selectedService === 'event' && durationSelect) {
                        const originalPrice = 100 * durationHours;
                        if (durationDiscount > 0) {
                            priceDisplay = `<span style="text-decoration: line-through; opacity: 0.6;">${originalPrice}‚Ç¨</span> ${basePrice}‚Ç¨`;
                        } else {
                            priceDisplay = `${basePrice}‚Ç¨`;
                        }
                    } else {
                        priceDisplay = `${basePrice}‚Ç¨`;
                    }

                    breakdownHTML += `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 500;">
                        <span>${serviceName}${selectedService === 'event' && durationHours > 0 ? ` (${durationHours}h)` : ''}</span>
                        <span>${priceDisplay}</span>
                    </div>`;

                    // Show duration discount explanation if applicable
                    if (durationDiscount > 0) {
                        breakdownHTML += `<div style="font-size: 0.85rem; color: var(--accent-color); margin-bottom: 0.5rem;">
                            ‚ú® ${durationDiscountPercent}% Rabatt f√ºr ${durationHours}h Buchung
                        </div>`;
                    }

                    // Add divider if there are extras
                    if (breakdown.length > 0) {
                        breakdownHTML += `<div style="border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 0.75rem 0; padding-top: 0.75rem;"></div>`;
                    }
                }

                // Add extras
                breakdownHTML += breakdown.map(item =>
                    `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>${item.name.replace(/\s*\(\+\d+‚Ç¨\)/, '')}</span>
                        <span>+${item.price}‚Ç¨</span>
                    </div>`
                ).join('');

                priceBreakdown.innerHTML = breakdownHTML;

                // Calculate discount for multiple extras (Complete Set)
                let extrasDiscount = 0;
                let extrasDiscountPercentage = 0;

                if (selectedCount === 3) {
                    extrasDiscountPercentage = 20; // 20% off for 3 extras
                    extrasDiscount = Math.round(extrasTotal * 0.20);
                } else if (selectedCount === 2) {
                    extrasDiscountPercentage = 15; // 15% off for 2 extras
                    extrasDiscount = Math.round(extrasTotal * 0.15);
                }

                if (extrasDiscount > 0) {
                    priceDiscount.style.display = 'block';
                    priceDiscount.innerHTML = `<div style="display: flex; justify-content: space-between;">
                        <span>üéâ Extras-Rabatt (${extrasDiscountPercentage}% bei ${selectedCount} Extras)</span>
                        <span>-${extrasDiscount}‚Ç¨</span>
                    </div>`;
                } else {
                    priceDiscount.style.display = 'none';
                }

                const finalTotal = basePrice + extrasTotal - extrasDiscount;
                priceTotal.innerHTML = `<div style="display: flex; justify-content: space-between;">
                    <span data-i18n="booking.price_summary.total">Gesamt:</span>
                    <span>${finalTotal}‚Ç¨</span>
                </div>`;

                // --- Populate Hidden Inputs for EmailJS ---
                const totalPriceInput = document.getElementById('total_price_input');
                const priceDetailsInput = document.getElementById('price_details_input');

                // New granular inputs
                const basePriceInput = document.getElementById('base_price_input');
                const extrasBreakdownInput = document.getElementById('extras_breakdown_input');
                const discountBreakdownInput = document.getElementById('discount_breakdown_input');

                // Handle "Other" / General Question case
                if (serviceSelect.value === 'other') {
                    if (totalPriceInput) totalPriceInput.value = "0‚Ç¨";
                    if (basePriceInput) basePriceInput.value = "Allgemeine Anfrage (0‚Ç¨)";
                    if (extrasBreakdownInput) extrasBreakdownInput.value = "Keine Extras";
                    if (discountBreakdownInput) discountBreakdownInput.value = "Kein Rabatt";
                    if (priceDetailsInput) priceDetailsInput.value = "Allgemeine Anfrage: 0‚Ç¨";
                    return; // Exit early for "other" case
                }

                if (totalPriceInput) {
                    totalPriceInput.value = `${finalTotal}‚Ç¨`;
                }

                // Populate granular inputs
                if (basePriceInput) {
                    if (basePrice > 0) {
                        const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
                        let baseText = `${serviceName}: ${basePrice}‚Ç¨`;
                        if (durationDiscount > 0) {
                            baseText += ` (Inkl. ${durationDiscountPercent}% Langzeit-Rabatt)`;
                        }
                        basePriceInput.value = baseText;
                    } else {
                        basePriceInput.value = "Preis auf Anfrage";
                    }
                }

                if (extrasBreakdownInput) {
                    if (breakdown.length > 0) {
                        let extrasText = "";
                        breakdown.forEach(item => {
                            extrasText += `- ${item.name.replace(/\s*\(\+\d+‚Ç¨\)/, '')}: +${item.price}‚Ç¨\n`;
                        });
                        extrasBreakdownInput.value = extrasText;
                    } else {
                        extrasBreakdownInput.value = "Keine Extras gew√§hlt";
                    }
                }

                if (discountBreakdownInput) {
                    if (extrasDiscount > 0) {
                        discountBreakdownInput.value = `Bundle-Rabatt (${extrasDiscountPercentage}%): -${extrasDiscount}‚Ç¨`;
                    } else {
                        discountBreakdownInput.value = "Kein Rabatt";
                    }
                }

                // Keep the full details input for backward compatibility or full summary
                if (priceDetailsInput) {
                    let detailsText = '';

                    // Base Price
                    if (basePriceInput && basePriceInput.value) {
                        detailsText += `${basePriceInput.value}\n`;
                    }

                    // Extras
                    if (breakdown.length > 0) {
                        detailsText += `\nExtras:\n`;
                        breakdown.forEach(item => {
                            detailsText += `- ${item.name.replace(/\s*\(\+\d+‚Ç¨\)/, '')}: +${item.price}‚Ç¨\n`;
                        });
                    }

                    // Discount
                    if (extrasDiscount > 0) {
                        detailsText += `\nRabatt (${extrasDiscountPercentage}%): -${extrasDiscount}‚Ç¨\n`;
                    }

                    priceDetailsInput.value = detailsText;
                }

                // Re-apply translations to dynamically updated content
                if (window.updateContent) {
                    window.updateContent();
                }
            }

            // Function to update tips
            function updateTips() {
                const photosSelect = extrasContainer.querySelector('select[name="extra_photos"]');
                const locationSelect = extrasContainer.querySelector('select[name="extra_location"]');
                const timeSelect = extrasContainer.querySelector('select[name="extra_time"]');

                bookingTips.innerHTML = '';
                let activeTip = '';
                let defaultText = '';

                const hasPhotos = photosSelect && photosSelect.value !== 'none';
                const hasLocation = locationSelect && locationSelect.value !== 'none';
                const hasTime = timeSelect && timeSelect.value !== 'none';
                const allSelected = hasPhotos && hasLocation && hasTime;

                if (!allSelected) {
                    // Priority 1: Location selected but NO time extension (Critical constraint)
                    if (hasLocation && !hasTime) {
                        activeTip = 'booking.tip.location';
                        defaultText = '<strong>Tipp:</strong> Bei mehreren Locations empfehlen wir, auch die Shooting-Zeit zu verl√§ngern, um den Ortswechsel entspannt zu gestalten.';
                    }
                    // Priority 2: Time extension selected but missing others (Optimization)
                    else if (hasTime && (!hasLocation || !hasPhotos)) {
                        activeTip = 'booking.tip.time';
                        defaultText = '<strong>Tipp:</strong> Da du mehr Zeit gebucht hast, nutze sie doch f√ºr eine weitere Location oder mehr Bilder, um das Beste herauszuholen.';
                    }
                    // Priority 3: Photos selected but missing others (Optimization)
                    else if (hasPhotos && (!hasLocation || !hasTime)) {
                        activeTip = 'booking.tip.photos';
                        defaultText = '<strong>Tipp:</strong> Wenn du mehr Fotos ausw√§hlst, lohnt es sich oft, auch mehr Zeit oder eine weitere Location einzuplanen, um mehr Abwechslung zu schaffen.';
                    }
                }

                if (activeTip) {
                    bookingTips.innerHTML = `
                        <div class="booking-tip" data-i18n="${activeTip}" 
                             style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent-color, #d4af37); font-size: 0.9rem; color: var(--text-secondary);">
                             ${defaultText}
                        </div>`;

                    if (window.updateContent) {
                        window.updateContent();
                    }
                }
            }

            // Initial render
            renderExtras(serviceSelect.value);

            // Listen for changes
            serviceSelect.addEventListener('change', (e) => {
                renderExtras(e.target.value);
            });
        });
    </script>
</body>

</html>