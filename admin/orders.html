<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zahlungs-Admin | Photon Capture</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container" style="padding-top: 5rem;">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <h1 style="text-align: center;">Admin Login</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">Zahlungsverwaltung</p>

            <div id="login-error" class="error-message" style="display: none;">Falsches Passwort</div>

            <form id="login-form">
                <div class="form-group">
                    <label for="admin-password">Passwort</label>
                    <input type="password" id="admin-password" class="form-control" required autofocus>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Anmelden</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" style="display: none;">
        <div class="admin-container">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--glass-border);">
                <div>
                    <h1>Zahlungsverwaltung</h1>
                    <p style="color: var(--text-secondary);">Verwalte Buchungen und Zahlungen</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="save-data-btn" class="btn btn-success">ðŸ’¾ Konfiguration Speichern</button>
                    <button id="logout-btn" class="btn btn-secondary">Abmelden</button>
                </div>
            </div>

            <div class="alert alert-warning">
                <strong>Wichtig:</strong> Ã„nderungen werden nicht automatisch gespeichert. Klicke auf "Konfiguration
                Speichern",
                um die neue <code>orders.js</code> Datei herunterzuladen und in <code>payment/data/</code> hochzuladen.
            </div>

            <!-- Statistics -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="card" style="text-align: center;">
                    <h3 id="total-orders">0</h3>
                    <p style="color: var(--text-secondary);">Gesamt Bestellungen</p>
                </div>
                <div class="card" style="text-align: center;">
                    <h3 id="pending-deposits" style="color: var(--warning-color);">0</h3>
                    <p style="color: var(--text-secondary);">Ausstehende Anzahlungen</p>
                </div>
                <div class="card" style="text-align: center;">
                    <h3 id="pending-finals" style="color: var(--warning-color);">0</h3>
                    <p style="color: var(--text-secondary);">Ausstehende Restzahlungen</p>
                </div>
                <div class="card" style="text-align: center;">
                    <h3 id="total-revenue" style="color: var(--success-color);">0 â‚¬</h3>
                    <p style="color: var(--text-secondary);">Eingenommener Betrag</p>
                </div>
            </div>

            <!-- Orders List -->
            <div class="card">
                <h2>Alle Bestellungen</h2>
                <div id="orders-list" class="orders-list">
                    <!-- Orders will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script src="../payment/data/orders.js"></script>
    <script src="js/payment-main.js"></script>
    <script>
        let orders = [];

        // Auth Check
        async function checkAuth() {
            if (AdminAuth.requireAuth()) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                await loadOrdersData();
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('admin-dashboard').style.display = 'none';
            }
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (AdminAuth.login(password)) {
                checkAuth();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            AdminAuth.logout();
        });

        // Load Orders
        async function loadOrdersData() {
            try {
                // Load from Local API
                const response = await fetch('api/orders.php');
                const data = await response.json();

                if (data.orders) {
                    orders = data.orders;
                } else {
                    orders = [];
                }

                console.log('Loaded', orders.length, 'orders from API');
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
            }

            renderOrders();
            updateStatistics();
        }

        // ... (Render Orders function skipped, it's fine) ...

        // Helper to update order via API
        async function updateOrderViaAPI(orderId, updates) {
            try {
                const response = await fetch('api/orders.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        updates: updates
                    })
                });

                const result = await response.json();
                return result.success || false;
            } catch (error) {
                console.error('Error updating order:', error);
                alert('Fehler beim Aktualisieren der Bestellung');
                return false;
            }
        }

        // Save Data
        document.getElementById('save-data-btn').addEventListener('click', () => {
            const data = { orders };
            const jsonStr = JSON.stringify(data, null, 2);
            const jsContent = `window.ordersDatabase = ${jsonStr};`;

            const dataBlob = new Blob([jsContent], { type: 'application/javascript' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = 'orders.js';
            link.click();

            URL.revokeObjectURL(url);

            alert('Die Datei orders.js wurde heruntergeladen. Bitte lade sie in den Ordner payment/data/ hoch.');
        });

        // Init
        checkAuth();
    </script>
</body>

</html>