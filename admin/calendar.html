<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender Manager | Photon Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .day-cell {
            background: var(--surface-dark);
            border: 1px solid var(--border);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-cell:hover {
            border-color: var(--text-primary);
        }

        .day-cell.header {
            background: transparent;
            border: none;
            cursor: default;
            text-align: center;
            font-weight: 600;
            padding-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .day-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-align: center;
        }

        .status-available {
            background: rgba(0, 184, 148, 0.2);
            color: #00b894;
        }

        .status-booked {
            background: rgba(255, 77, 77, 0.2);
            color: #ff4d4d;
        }

        .status-reserved {
            background: rgba(253, 203, 110, 0.2);
            color: #fdcb6e;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: var(--surface-light);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="welcome-text">
                <h1>Kalender Manager</h1>
                <p><a href="dashboard.html" style="color: var(--accent); text-decoration: none;">&larr; Zurück zum
                        Dashboard</a></p>
            </div>
            <button onclick="saveChanges()" class="btn" style="width: auto; padding: 0.5rem 2rem;">Speichern</button>
        </header>

        <div class="controls">
            <div class="month-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">&lt;</button>
                <h2 id="currentMonthDisplay">Dezember 2025</h2>
                <button class="nav-btn" onclick="changeMonth(1)">&gt;</button>
            </div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- Generated by JS -->
        </div>
    </div>

    <script>
        // Auth Check
        if (sessionStorage.getItem('photon_admin_auth') !== 'true') window.location.href = 'index.html';

        let currentDate = new Date();
        let calendarData = {};

        // Fetch data
        async function loadData() {
            try {
                const response = await fetch('../data/calendar.json');
                calendarData = await response.json();
                renderCalendar();
            } catch (e) {
                console.error("Could not load calendar data", e);
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Header
            const monthNames = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
            document.getElementById('currentMonthDisplay').textContent = `${monthNames[month]} ${year}`;

            // Weekdays
            const weekdays = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
            weekdays.forEach(day => {
                const div = document.createElement('div');
                div.className = 'day-cell header';
                div.textContent = day;
                grid.appendChild(div);
            });

            // Days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            // Empty slots
            for (let i = 0; i < startingDay; i++) {
                const div = document.createElement('div');
                div.className = 'day-cell empty';
                grid.appendChild(div);
            }

            // Dates
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                // Default status available if not in JSON, unless passed
                const status = calendarData[dateStr]?.status || 'available';

                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.onclick = () => toggleStatus(dateStr);

                const dayNum = document.createElement('div');
                dayNum.textContent = d;

                const statusBadge = document.createElement('div');
                statusBadge.className = `status-badge status-${status}`;
                statusBadge.textContent = status === 'available' ? 'Frei' : (status === 'booked' ? 'Gebucht' : 'Reserviert');

                cell.appendChild(dayNum);
                cell.appendChild(statusBadge);
                grid.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function toggleStatus(dateStr) {
            const current = calendarData[dateStr]?.status || 'available';
            const next = current === 'available' ? 'reserved' : (current === 'reserved' ? 'booked' : 'available');

            if (next === 'available') {
                delete calendarData[dateStr];
            } else {
                calendarData[dateStr] = { status: next };
            }
            renderCalendar();
        }

        async function saveChanges() {
            const btn = document.querySelector('button[onclick="saveChanges()"]');
            const originalText = btn.textContent;
            btn.textContent = 'Speichert...';
            btn.disabled = true;

            try {
                const response = await fetch('api/save_calendar.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(calendarData)
                });

                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error('Server Return Invalid JSON: ' + text.substring(0, 100));
                }

                if (result.success) {
                    alert('Änderungen erfolgreich gespeichert!');
                    btn.textContent = 'Gespeichert';
                    setTimeout(() => btn.textContent = originalText, 2000);
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (e) {
                console.error("Save failed", e);
                alert('Fehler beim Speichern: ' + e.message);
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
            }
        }

        loadData();
    </script>
</body>

</html>